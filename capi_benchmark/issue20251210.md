# Issue: メモリ使用量の問題 - beta=1e+5, epsilon=1e-10 での "Killed: 9" エラー

## 問題の概要

`benchmark1.c`を実行した際、`beta=1e+5, epsilon=1e-10`のパラメータで "Killed: 9" エラーが発生しています。これは通常、メモリ不足やセグメンテーションフォルトが原因です。

## 発生状況

### エラーが発生する条件
- `beta = 1e+5`
- `epsilon = 1e-10`
- `extra_size = 1000`
- `nrun = 10000`

### エラーログ
```
Benchmark (beta = 1e+5, epsilon = 1e-10)
Benchmark (positive only = false)
...
fit_zz (Matsubara)            : 39761.683000 ms
gmake[3]: *** [CMakeFiles/benchmark.dir/build.make:80: benchmark] Killed: 9
```

## 原因の特定

デバッグ用のCファイル（`debug_benchmark.c`, `test_sve_memory.c`）を作成し、メモリ使用量を詳細に調査しました。

### メモリ使用量の測定方法

1. **最大メモリ使用量（累積）**: `getrusage(RUSAGE_SELF, &usage)`の`ru_maxrss`を使用
   - プロセスが使用した最大の物理メモリ量（累積値）
   - macOSではキロバイト単位

2. **現在のメモリ使用量（実際の使用量）**: macOSでは`task_info(mach_task_self(), TASK_BASIC_INFO, ...)`を使用
   - 現在の実際のメモリ使用量
   - メモリが解放されると値が減る

### 調査結果

#### SVE計算のみのメモリ使用量

| beta | epsilon | lambda | SVE計算後のメモリ使用量 |
|------|---------|--------|------------------------|
| 1e+3 | 1e-6    | 1e+3   | 約28GB (28.39 GB) |
| 1e+4 | 1e-8    | 1e+4   | 約53GB (52.66 GB) |
| 1e+5 | 1e-10   | 1e+5   | **約253GB (252.56 GB)** |

#### mdarrayバージョンによる比較

| mdarrayバージョン | SVE計算後のメモリ使用量 |
|------------------|----------------------|
| **0.7.1** (mainブランチ) | **約254GB** (254,720 MB) |
| **0.7.2** | **約237GB** (237,696 MB) |

### 問題の根本原因

1. **SVE計算の段階で大量のメモリを使用**
   - `beta=1e+5, epsilon=1e-10`では、SVE計算だけで約250GBのメモリを使用
   - これは`beta`と`epsilon`の組み合わせによるもの

2. **メモリ制限による強制終了**
   - `extra_size=1000, nrun=10000`のループでさらにメモリが必要
   - システムのメモリ制限に達して "Killed: 9" が発生

3. **メモリは適切に解放されている**
   - SVE計算中に一時的に大量のメモリを使用するが、計算後は適切に解放される
   - 現在のメモリ使用量は約230MB程度まで減少

## 修正された問題

- `benchmark1.c`で`g_basis_d`がfreeされていなかったメモリリークを修正

## 推奨される対応

1. **Rust側のSVE実装のメモリ最適化**
   - SVE計算でのメモリ使用量を削減
   - 特に`beta`が大きい場合のメモリ効率を改善

2. **より小さいパラメータでのテスト**
   - `beta=1e+4`など、より現実的なパラメータでのテストを推奨
   - `extra_size`や`nrun`を減らしてテスト

3. **メモリリークの確認**
   - SVE計算後のメモリが適切に解放されているか確認（現在は問題なし）

## デバッグツール

以下のデバッグ用ファイルを作成しました：

1. **`debug_benchmark.c`**: 詳細なエラーチェックとメモリ使用量の監視
2. **`test_sve_memory.c`**: SVE計算のみのメモリ使用量を測定
3. **`run_debug.sh`**: ライブラリのビルドからデバッグ実行まで自動化
4. **`DEBUG_README.md`**: デバッグツールの使用方法

### 使用方法

```bash
# デフォルト設定（beta=1e+5, epsilon=1e-10）で実行
./run_debug.sh

# カスタムパラメータで実行
./run_debug.sh [beta] [epsilon] [extra_size] [nrun] [positive_only]

# SVE計算のみのメモリ使用量を測定
cd _build
./test_sve_memory 1e+5 1e-10
```

## 関連ファイル

- `capi_benchmark/benchmark1.c`: 元のベンチマークファイル
- `capi_benchmark/debug_benchmark.c`: デバッグ用ベンチマークファイル
- `capi_benchmark/test_sve_memory.c`: SVE計算のみのメモリテスト
- `capi_benchmark/run_debug.sh`: デバッグ実行スクリプト
- `capi_benchmark/DEBUG_README.md`: デバッグツールの説明

## 日付

2025年12月10日
