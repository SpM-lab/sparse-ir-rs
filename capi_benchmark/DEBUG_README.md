# Debug Benchmark Guide

このファイルは、`benchmark1.c`で発生する "Killed: 9" エラーをデバッグするためのツールです。

## 問題の概要

`beta = 1e+5, epsilon = 1e-10` のケースで、`fit_zz (Matsubara)` の実行中に "Killed: 9" エラーが発生しています。これは通常、メモリ不足やセグメンテーションフォルトが原因です。

## デバッグファイルの機能

`debug_benchmark.c` は以下の機能を提供します：

1. **詳細なエラーチェック**: 各API呼び出しの戻り値をチェックし、エラーメッセージを表示
2. **メモリ使用量の監視**: 各ステップでのメモリ使用量を表示
3. **段階的な実行**: 各ステップで停止し、問題の発生箇所を特定
4. **メモリリークの検出**: すべてのメモリが適切に解放されていることを確認

## 使用方法

### 1. ビルドと実行（デフォルト設定）

```bash
./run_debug.sh
```

デフォルト設定：
- beta: 1e+5
- epsilon: 1e-10
- extra_size: 1000
- nrun: 10000
- positive_only: false

### 2. カスタムパラメータで実行

```bash
./run_debug.sh [beta] [epsilon] [extra_size] [nrun] [positive_only]
```

例：
```bash
# より小さいパラメータでテスト
./run_debug.sh 1e+3 1e-6 100 1000 0

# より大きいパラメータでテスト
./run_debug.sh 1e+5 1e-10 2000 20000 0
```

### 3. 手動ビルドと実行

```bash
# ライブラリのビルド（初回のみ）
./run_with_rust_capi.sh

# CMakeでビルド
cd _build
cmake ..
make debug_benchmark

# 実行
./debug_benchmark [beta] [epsilon] [extra_size] [nrun] [positive_only]
```

## 出力の見方

デバッグファイルは以下の情報を出力します：

- `[STEP N]`: 実行ステップの番号と説明
- `[OK]`: ステップが正常に完了
- `[ERROR]`: エラーが発生（詳細なエラーコードも表示）
- `[MEMORY]`: その時点でのメモリ使用量（MB）
- `Allocated ... size`: 割り当てられたメモリサイズ（MB）

## 問題の特定方法

1. **エラーが発生したステップを確認**: `[ERROR]` メッセージでどのステップで失敗したかを確認
2. **メモリ使用量の推移を確認**: 急激にメモリ使用量が増加している場合は、メモリリークの可能性
3. **イテレーション中のエラー**: `fit_zz` などのループ中にエラーが発生した場合、何回目のイテレーションで失敗したかを確認

## 修正された問題

- `benchmark1.c` で `g_basis_d` がfreeされていなかった問題を修正

## 次のステップ

デバッグファイルで問題が特定できたら：

1. 問題の原因を特定（メモリ不足、セグメンテーションフォルト、メモリリークなど）
2. 必要に応じて、より小さいパラメータでテストして再現性を確認
3. Rust側のC API実装を確認し、問題を修正
