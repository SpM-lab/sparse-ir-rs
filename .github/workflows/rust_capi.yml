name: Rust-CAPI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5
      with:
        submodules: false
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Check version consistency
      run: python3 check_version.py
    - name: Install OpenBLAS
      run: |
        sudo apt-get update
        sudo apt-get install -y libopenblas-dev pkg-config
    - name: Initialize and update submodules
      run: |
        # Convert SSH URLs to HTTPS for GitHub Actions
        git config --global url."https://github.com/".insteadOf "git@github.com:"
        git submodule update --init --jobs 4
        # Initialize libsparseir submodules but skip nested ones that may have issues
        cd libsparseir && git submodule update --init --jobs 4 || true
    - name: Build
      run: cargo build -p sparse-ir-capi --release
    - name: Run tests
      run: cargo test -p sparse-ir-capi --release
